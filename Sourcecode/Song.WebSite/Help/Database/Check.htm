<!DOCTYPE html>
<html lang="en">

<head resource>
    <meta charset="utf-8">
    <meta view="Check" page="/Help/DataBase/Check.htm" />
    <title>校验数据库</title>
    <script type="text/javascript" src="/Utilities/Scripts/webdom.js"></script>
    <script type="text/javascript" src="../Scripts/core.js"></script>
</head>

<body>
    <div id="vapp" v-cloak>
        <header>
            <div class="mainbtns">
                <el-button type="primary" :disabled="loading" :loading="loadstate.checkfully" plain @click="checkFully">
                    检测表与字段的完整性</el-button>
                <el-button type="success" :disabled="loading" plain @click="checkRedundancy">检测结构冗余</el-button>
                <el-button type="warning" :disabled="loading" plain @click="checkCorrect">校验数据类型</el-button>
            </div>
            <loading v-if="loading"></loading>
            <div class="database" v-else>
                <span :class="dbType.toLowerCase()">
                    <icon v-if="dbType=='SQLite'">&#xa05b</icon>
                    <icon v-if="dbType=='PostgreSQL'">&#xa05d</icon>
                    <icon v-if="dbType=='SQLServer'">&#xa05a</icon>
                    <span>{{dbType}}</span>
                    <span v-if="dbName!=''" class="dbName"> ({{dbName}})</span>

                </span>
                <template v-if="!connState">
                    <el-tag type="danger" class="el-icon-link connState">数据库链接失败</el-tag>
                    <div class="error" v-if="error!=''">
                        提示信息：{{error}}
                    </div>
                    <help multi>帮助<br />
                        1、请检查db.config中的数据库链接配置项
                        <br />
                        2、检测数据库服务是否启用
                    </help>
                </template>
            </div>
        </header>
        <div v-if="checkState==''" class="helpbox">
            <p>说明</p>
            <help multi>检测表与字段的完整性<br />
                此功能是检测数据库中所有表和字段，是否满足软件设计需求，检查缺失的表和字段。
                <br />
                如果有缺失，可以查阅SQL升级脚本，执行相应的脚本，升级数据库。

            </help>
            <help multi>检测结构冗余<br />
                冗余的表或字段是指在数据库中存在，但是在软件设计中不存在。<br />
                虽然大多数冗余字段不会影响操作，但是当某个冗余字段不可为空时，新增数据会失败。<br />
                因此，尽可能删除冗余的表或字段。删除需要人工处理，强烈建议操作前备份数据库。

            </help>
            <help multi>校验数据类型<br />
                此功能是检测数据库中字段的数据类型，是否满足软件设计需求。<br />
                如果字段的数据类型与软件设计中的数据类型不一致，可能会导致数据丢失。<br />
                因此，尽可能将数据类型修改为软件设计中的数据类型。
            </help>
        </div>

        <!--检测完整性-->
        <section class="checkFully" v-else-if="checkState=='checkFully'">
            <loading v-if="loadstate.checkfully"> 正在检测...</loading>
            <template v-else-if="missingDatas.length>0">
                <div class="data_title">
                    <span> 缺失表或字段</span>
                    <help>查找缺失的SQL脚本，<a href="https://gitee.com/weishakeji/LearningSystem/tree/master/DbScripts"
                            target="_blank">点这里</a></help>
                </div>
                <div v-for="(item,index) in missingDatas" class="data_row">
                    {{index+1}}.
                    <span v-for="(val,key,i) in item">
                        {{key}}<br />
                        <template v-if="val.length>0">
                            <span v-for="(field,j) in val">
                                <el-tag type="info"> {{field}}</el-tag>
                            </span>
                        </template>
                        <el-tag v-else type="warning"> 缺失整个表</el-tag>
                    </span>
                </div>
            </template>
            <el-tag v-else type="primary">
                <icon>&#xa048</icon> 没有缺失的表或字段
            </el-tag>
        </section>
        <!--检测冗余-->
        <section class="redundancy" v-else-if="checkState=='checkRedundancy'">
            <loading v-if="loadstate.redundancy"> 正在检测...</loading>
            <template v-else-if="redundancyDatas.length>0">
                <div class="data_title">
                    <span> 冗余的表与字段</span>
                </div>
                <div v-for="(item,index) in redundancyDatas" class="data_row">
                    {{index+1}}.
                    <span v-for="(val,key,i) in item">
                        {{key}}<br />
                        <template v-if="val.length>0">
                            <span v-for="(field,j) in val">
                                <el-tag type="info"> {{field}}</el-tag>
                            </span>
                        </template>
                        <el-tag v-else type="warning"> 整个表冗余</el-tag>
                    </span>
                </div>
            </template>
            <el-tag v-else type="success">
                <icon>&#xa048</icon> 没有冗余的表或字段
            </el-tag>
        </section>
        <!--检测数据库字段类型的正确性-->
        <section class="errorfields" v-else-if="checkState=='checkCorrect'">
            <loading v-if="loadstate.correct"> 正在检测...</loading>
            <template v-else-if="!$api.isnull(errorfields)">
                <div class="data_title">
                    <span> 数据类型错误的字段</span>
                </div>
                <div v-for="(fields,table,index) in errorfields" class="data_row">
                    {{index+1}}. {{table}}
                    <div v-for="(val,key,i) in fields">
                        <el-tag type="info">{{key}}</el-tag> 当前数据类型 <b>{{val.original}}</b>，
                        对应于C#类型 <b>{{val.csharp}}</b>，
                        应该设计为<b> {{val.correct}}</b> 类型。

                    </div>
                </div>
            </template>
            <el-tag v-else type="warning">
                <icon>&#xa048</icon> 没有错误的数据类型
            </el-tag>
        </section>
    </div>
</body>

</html>